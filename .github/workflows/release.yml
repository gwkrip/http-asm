name: Release Build

on:
  push:
    tags:
      - "v*.*.*"

  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (contoh: v1.0.0)"
        required: true
        default: "v0.0.0-dev"

permissions:
  contents: write

env:
  BINARY_NAME: http_server

jobs:
  build:
    name: Build — ${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch:    x86_64
            src:     arch/x86_64/http_server.asm
            out:     build/http_server_x86_64
            obj:     build/http_server_x86_64.o
            as_cmd:  "nasm -f elf64 -w+all"
            ld_cmd:  "ld --strip-all"
            elf_chk: "ELF 64-bit LSB executable, x86-64"

          - arch:    arm64
            src:     arch/arm64/http_server.s
            out:     build/http_server_arm64
            obj:     build/http_server_arm64.o
            as_cmd:  "aarch64-linux-musl-as"
            ld_cmd:  "aarch64-linux-musl-ld --static --strip-all"
            elf_chk: "ELF 64-bit LSB executable, ARM aarch64"

    outputs:
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install toolchain (x86_64)
        if: matrix.arch == 'x86_64'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends nasm binutils file
          nasm --version
          ld --version | head -1

      - name: Install toolchain (arm64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            musl-tools \
            binutils-aarch64-linux-gnu \
            gcc-aarch64-linux-gnu \
            qemu-user-static \
            file
          aarch64-linux-musl-as --version | head -1
          aarch64-linux-musl-ld --version | head -1

      - name: Assemble
        run: |
          mkdir -p build
          ${{ matrix.as_cmd }} ${{ matrix.src }} -o ${{ matrix.obj }}

      - name: Link
        run: |
          ${{ matrix.ld_cmd }} ${{ matrix.obj }} -o ${{ matrix.out }}

      - name: Verify binary
        run: |
          file ${{ matrix.out }}
          size ${{ matrix.out }}
          ls -lh ${{ matrix.out }}
          file ${{ matrix.out }} | grep -q "${{ matrix.elf_chk }}" \
            || (echo "❌ ELF check gagal!" && exit 1)
          echo "✅ ELF valid: ${{ matrix.arch }}"

      - name: Smoke test (x86_64)
        if: matrix.arch == 'x86_64'
        run: |
          ./${{ matrix.out }} &
          SERVER_PID=$!

          for i in $(seq 1 6); do
            sleep 0.5
            curl -sf http://localhost:8080/ > /dev/null 2>&1 && break
            [ $i -eq 6 ] && echo "❌ Server timeout" && kill $SERVER_PID && exit 1
          done
          echo "✅ Server ready"

          FAILED=0
          for METHOD in GET POST PUT DELETE PATCH OPTIONS; do
            RES=$(curl -sf -X "$METHOD" http://localhost:8080/ 2>/dev/null)
            [ "$RES" = "OK" ] && echo "  ✅ $METHOD" || { echo "  ❌ $METHOD → '$RES'"; FAILED=$((FAILED+1)); }
          done

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X HEAD http://localhost:8080/)
          [ "$STATUS" = "200" ] && echo "  ✅ HEAD" || { echo "  ❌ HEAD → $STATUS"; FAILED=$((FAILED+1)); }

          kill $SERVER_PID 2>/dev/null; wait $SERVER_PID 2>/dev/null || true
          [ $FAILED -gt 0 ] && echo "❌ $FAILED method(s) gagal" && exit 1
          echo "✅ Semua method passed"

      - name: Smoke test (arm64 via qemu)
        if: matrix.arch == 'arm64'
        run: |
          qemu-aarch64-static ${{ matrix.out }} &
          SERVER_PID=$!

          for i in $(seq 1 6); do
            sleep 0.5
            curl -sf http://localhost:8080/ > /dev/null 2>&1 && break
            [ $i -eq 6 ] && echo "❌ Server timeout" && kill $SERVER_PID && exit 1
          done
          echo "✅ Server ready (qemu-aarch64)"

          FAILED=0
          for METHOD in GET POST PUT DELETE PATCH OPTIONS; do
            RES=$(curl -sf -X "$METHOD" http://localhost:8080/ 2>/dev/null)
            [ "$RES" = "OK" ] && echo "  ✅ $METHOD" || { echo "  ❌ $METHOD → '$RES'"; FAILED=$((FAILED+1)); }
          done

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X HEAD http://localhost:8080/)
          [ "$STATUS" = "200" ] && echo "  ✅ HEAD" || { echo "  ❌ HEAD → $STATUS"; FAILED=$((FAILED+1)); }

          kill $SERVER_PID 2>/dev/null; wait $SERVER_PID 2>/dev/null || true
          [ $FAILED -gt 0 ] && echo "❌ $FAILED method(s) gagal" && exit 1
          echo "✅ Semua method passed (qemu-aarch64)"

      - name: Collect metadata
        id: meta
        run: |
          VERSION=${{ steps.version.outputs.tag }}
          BINARY_SIZE=$(wc -c < ${{ matrix.out }})
          SHA256=$(sha256sum ${{ matrix.out }} | cut -d' ' -f1)

          echo "version=$VERSION"         >> $GITHUB_OUTPUT
          echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256"           >> $GITHUB_OUTPUT

          echo "  Version     : $VERSION"
          echo "  Arch        : ${{ matrix.arch }}"
          echo "  Binary size : $BINARY_SIZE bytes"
          echo "  SHA256      : $SHA256"

      - name: Generate SHA256SUMS
        run: |
          sha256sum ${{ matrix.out }} ${{ matrix.src }} \
            > build/SHA256SUMS_${{ matrix.arch }}
          cat build/SHA256SUMS_${{ matrix.arch }}

      - name: Package archive
        run: |
          VERSION=${{ steps.version.outputs.tag }}
          ARCHIVE="http_server-${VERSION}-linux-${{ matrix.arch }}.tar.gz"
          tar -czf "build/$ARCHIVE" \
            -C build \
            $(basename ${{ matrix.out }}) \
            SHA256SUMS_${{ matrix.arch }} \
            --transform "s|^|http_server-${VERSION}-linux-${{ matrix.arch }}/|" \
            && tar -czf "build/$ARCHIVE" \
              ${{ matrix.out }} \
              ${{ matrix.src }} \
              Makefile \
              build/SHA256SUMS_${{ matrix.arch }}
          echo "ARCHIVE=build/$ARCHIVE" >> $GITHUB_ENV
          ls -lh "build/$ARCHIVE"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: http_server-${{ steps.version.outputs.tag }}-linux-${{ matrix.arch }}
          path: |
            ${{ matrix.out }}
            ${{ matrix.src }}
            build/SHA256SUMS_${{ matrix.arch }}
            ${{ env.ARCHIVE }}
          retention-days: 30
          if-no-files-found: error

      - name: Write job summary
        run: |
          VERSION=${{ steps.version.outputs.tag }}
          BINARY_SIZE=${{ steps.meta.outputs.binary_size }}
          SHA256=${{ steps.meta.outputs.sha256 }}
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${{ matrix.arch }}
          | | |
          |---|---|
          | **Version** | \`$VERSION\` |
          | **Arch** | ${{ matrix.arch }} |
          | **Binary size** | ${BINARY_SIZE} bytes |
          | **SHA256** | \`${SHA256}\` |
          EOF

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.tag }}
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${VERSION}$" | head -1)
          [ -n "$PREV_TAG" ] && LOG_RANGE="${PREV_TAG}..HEAD" || LOG_RANGE="HEAD"

          cat > /tmp/changelog.md << EOF
          Ultra-fast, zero-allocation HTTP server — Linux Assembly (x86-64 + ARM64).

          | Property | Value |
          |---|---|
          | Architectures | x86-64 · ARM64 (musl static) |
          | Allocation | zero |
          | TCP options | NODELAY · QUICKACK · DEFER_ACCEPT · REUSEPORT · FASTOPEN |
          | Syscalls/req | 7 |

          | File | Keterangan |
          |---|---|
          | \`http_server_x86_64\` | ELF64 binary, stripped |
          | \`http_server_arm64\` | ELF64 ARM64 binary, static musl |
          | \`*.tar.gz\` | Archive per arsitektur |
          | \`SHA256SUMS_*\` | Checksum per arsitektur |

          \`\`\`bash
          chmod +x http_server_x86_64 && ./http_server_x86_64
          curl http://localhost:8080/
          \`\`\`
          EOF

          if [ -n "$PREV_TAG" ]; then
            echo "" >> /tmp/changelog.md
            echo "### Changes since ${PREV_TAG}" >> /tmp/changelog.md
            git log "$LOG_RANGE" \
              --pretty=format:"- %s (%h)" \
              --no-merges >> /tmp/changelog.md || true
          fi

          echo "changelog_file=/tmp/changelog.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name:   ${{ steps.version.outputs.tag }}
          name:       "http_server ${{ steps.version.outputs.tag }}"
          body_path:  ${{ steps.changelog.outputs.changelog_file }}
          draft:      false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
